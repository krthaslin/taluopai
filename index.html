<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DESTINY PROTOCOL V3.3 TORNADO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background-color: #050505; color: white;
            font-family: 'Noto Serif SC', serif; 
            display: flex; flex-direction: column; align-items: center;
            perspective: 1000px; /* 3D 景深 */
        }

        :root {
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.5);
            --neon: #9d00ff;
            --card-w-mobile: 80px; 
            --card-h-mobile: 140px;
            --card-w-zoom: 240px;
            --card-h-zoom: 420px;
        }

        .bg-gradient {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%);
            z-index: -1;
        }

        /* --- 区域 1: 舞台中心 (Flex 调整为 55%，视觉更居中) --- */
        .stage-area {
            flex: 55; width: 100%;
            display: flex; flex-direction: column;
            justify-content: flex-end; /* 靠下对齐，接近物理中心 */
            align-items: center;
            position: relative; z-index: 10;
            padding-bottom: 40px;
        }

        /* 魔法阵 (交互核心) */
        .magic-circle-container {
            position: relative;
            width: 180px; height: 180px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; /* 提示可点击 */
            -webkit-user-select: none; user-select: none;
            transition: transform 0.2s;
        }
        .magic-circle-container:active { transform: scale(0.95); }

        .magic-circle {
            width: 100%; height: 100%; border-radius: 50%; position: absolute;
            border: 2px dashed var(--neon); box-shadow: 0 0 30px var(--neon), inset 0 0 20px var(--neon);
            animation: rotateSlow 20s linear infinite;
            background: radial-gradient(circle, transparent 60%, rgba(157, 0, 255, 0.2));
            transition: all 0.5s;
        }
        /* 激活状态：法阵狂暴 */
        .magic-circle.active {
            box-shadow: 0 0 80px var(--neon), inset 0 0 50px var(--neon);
            border-color: #fff;
            animation: rotateFast 1s linear infinite; 
        }
        
        .magic-circle::before {
            content: ''; position: absolute; width: 85%; height: 85%; border-radius: 50%;
            border: 1px solid var(--gold); border-top: 3px double var(--gold); border-bottom: 3px double var(--gold);
            top: 7.5%; left: 7.5%;
            animation: rotateSlow 12s linear infinite reverse;
        }

        /* 中心的提示文字 (代替按钮) */
        .circle-hint {
            position: absolute; color: var(--gold); font-size: 14px; font-weight: bold;
            text-align: center; pointer-events: none; letter-spacing: 2px;
            text-shadow: 0 0 10px black;
            animation: pulseText 2s infinite;
        }

        /* 龙卷风容器 */
        .tornado-wrapper {
            position: absolute; width: 100%; height: 100%;
            top: 0; left: 0; pointer-events: none;
            transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
        }
        /* 龙卷风中的单张卡片 */
        .storm-card {
            position: absolute; width: 40px; height: 60px;
            background: #222; border: 1px solid var(--gold-dim); border-radius: 3px;
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%);
            background-size: 8px 8px;
            opacity: 0; /* 初始不可见 */
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 输入框 (紧贴法阵下方) */
        .input-box {
            margin-top: 40px; width: 260px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 8px; color: var(--gold); padding: 12px; text-align: center; outline: none; 
            font-family: 'Noto Serif SC', serif; transition: opacity 0.5s;
        }

        /* 辅助提示语 */
        .status-text {
            margin-top: 15px; height: 20px;
            color: #888; font-size: 12px; letter-spacing: 1px;
            transition: opacity 0.3s;
        }

        /* --- 区域 2: 底部卡槽 (Flex 45%) --- */
        .slots-container {
            flex: 45; width: 100%;
            display: flex; justify-content: space-evenly; align-items: flex-start;
            padding-top: 20px;
            opacity: 0; pointer-events: none; transition: opacity 1s;
        }
        .slot {
            width: var(--card-w-mobile); height: var(--card-h-mobile);
            border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px;
            position: relative;
        }
        .slot::after {
            content: attr(data-label);
            position: absolute; bottom: -25px; width: 100%; text-align: center;
            color: #444; font-size: 10px; font-family: 'Cinzel'; letter-spacing: 2px;
        }

        /* --- 飞行动画与卡片样式 --- */
        .flying-card {
            position: fixed; width: var(--card-w-mobile); height: var(--card-h-mobile);
            border-radius: 6px; transform-style: preserve-3d;
            transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50; cursor: pointer;
        }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; overflow: hidden; }
        
        .back { background-color: #111; background-size: cover; background-position: center; border: 1px solid #444; }
        /* 纹理皮肤 */
        .back.moon { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.png'); }
        .back.star { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.png'); }
        .back.sun  { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.png'); }

        .front { 
            transform: rotateY(180deg); background: #000; 
            display: flex; flex-direction: column; justify-content: flex-end;
            box-shadow: inset 0 0 0 1px var(--gold-dim);
        }
        .front-content {
            padding: 8px; text-align: center; background: rgba(0,0,0,0.9);
            border-top: 1px solid var(--gold-dim); backdrop-filter: blur(4px);
        }
        .card-name { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .card-keywords { color: #aaa; font-size: 10px; transform: scale(0.9); white-space: nowrap; }

        /* 聚焦遮罩 */
        .overlay-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 90;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .flying-card.zoomed {
            width: var(--card-w-zoom) !important; height: var(--card-h-zoom) !important;
            z-index: 100;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) rotateY(180deg) !important;
            box-shadow: 0 0 60px rgba(157, 0, 255, 0.4);
        }
        .flying-card.zoomed .card-name { font-size: 24px; margin-bottom: 10px; }
        .flying-card.zoomed .card-keywords { font-size: 14px; color: #fff; transform: scale(1); white-space: normal; }

        /* 解读面板 */
        .synthesis-panel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #000 90%, transparent);
            padding: 30px 20px 60px; text-align: center;
            transform: translateY(100%); transition: transform 0.8s ease-out;
            z-index: 95;
        }
        .synthesis-title { color: var(--neon); font-family: 'Cinzel'; margin-bottom: 15px; font-size: 16px; letter-spacing: 4px; }
        .synthesis-text { color: #ececec; font-size: 15px; line-height: 1.8; text-align: justify; max-height: 250px; overflow-y: auto; }

        @keyframes rotateSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateFast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="bg-gradient"></div>
    <div class="overlay-mask" id="mask"></div>

    <div class="stage-area">
        
        <div class="tornado-wrapper" id="tornado-con"></div>

        <div class="magic-circle-container" id="magic-trigger">
            <div class="magic-circle" id="magic-ring"></div>
            <div class="circle-hint" id="circle-text">长按<br>注入能量</div>
        </div>

        <input type="text" class="input-box" id="user-input" placeholder="输入所求之事..." autocomplete="off">
        <div class="status-text" id="status-text"></div>
    </div>

    <div class="slots-container" id="slots-area">
        <div class="slot" id="slot-0" data-label="PAST"></div>
        <div class="slot" id="slot-1" data-label="PRESENT"></div>
        <div class="slot" id="slot-2" data-label="FUTURE"></div>
    </div>

    <div class="synthesis-panel" id="final-panel">
        <div class="synthesis-title">✧ 命运回响 ✧</div>
        <div class="synthesis-text" id="ai-text">正在接收深空信号...</div>
    </div>

    <script>
        // --- 1. 数据 ---
        const TAROT_DATA = [
            { id: "0", name: "愚者", en: "The Fool", keywords: "起点 · 自由 · 潜力", img: "https://upload.wikimedia.org/wikipedia/commons/9/90/RWS_Tarot_00_Fool.jpg" },
            { id: "I", name: "魔术师", en: "The Magician", keywords: "创造 · 力量 · 专注", img: "https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg" },
            { id: "II", name: "女祭司", en: "The High Priestess", keywords: "直觉 · 神秘 · 潜意识", img: "https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg" },
            { id: "III", name: "女皇", en: "The Empress", keywords: "丰饶 · 母性 · 自然", img: "https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg" },
            { id: "IV", name: "皇帝", en: "The Emperor", keywords: "权威 · 结构 · 稳固", img: "https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg" },
            { id: "IX", name: "隐士", en: "The Hermit", keywords: "内省 · 孤独 · 指引", img: "https://upload.wikimedia.org/wikipedia/commons/4/4d/RWS_Tarot_09_Hermit.jpg" },
            { id: "X", name: "命运之轮", en: "Wheel of Fortune", keywords: "流转 · 机遇 · 宿命", img: "https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg" },
            { id: "XII", name: "倒吊人", en: "The Hanged Man", keywords: "牺牲 · 等待 · 新视角", img: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg" },
            { id: "XIII", name: "死神", en: "Death", keywords: "结束 · 转变 · 重生", img: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg" },
            { id: "XIX", name: "太阳", en: "The Sun", keywords: "成功 · 喜悦 · 活力", img: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg" }
        ];

        let state = {
            shuffling: false,
            destinyLocked: false,
            selectedCards: [],
            currentSlot: 0,
            cardsRevealed: 0,
            tornadoCards: [] // 存储龙卷风里的DOM元素
        };

        // DOM 元素
        const trigger = document.getElementById('magic-trigger');
        const ring = document.getElementById('magic-ring');
        const circleText = document.getElementById('circle-text');
        const tornadoCon = document.getElementById('tornado-con');
        const inputBox = document.getElementById('user-input');
        const statusText = document.getElementById('status-text');

        // --- 2. 交互事件绑定 ---
        // 支持鼠标和触摸
        trigger.addEventListener('mousedown', startChanneling);
        trigger.addEventListener('touchstart', (e) => { e.preventDefault(); startChanneling(); });
        
        trigger.addEventListener('mouseup', stopChanneling);
        trigger.addEventListener('mouseleave', stopChanneling);
        trigger.addEventListener('touchend', stopChanneling);

        // --- 3. 核心逻辑 ---

        function startChanneling() {
            if (state.destinyLocked) return; // 锁定后不能再洗牌
            
            const query = inputBox.value;
            if (!query) {
                statusText.innerText = "请先输入心中的疑惑...";
                statusText.style.color = "#ff4444";
                return;
            }

            state.shuffling = true;
            ring.classList.add('active');
            circleText.innerText = "能量注入中...";
            statusText.innerText = "";
            
            createTornado(); // 召唤龙卷风
        }

        function stopChanneling() {
            if (!state.shuffling) return;
            
            state.shuffling = false;
            ring.classList.remove('active');
            
            // 锁定命运
            lockDestiny();
            
            // 收回龙卷风
            destroyTornado();

            // UI 变更
            circleText.innerText = ""; // 清空中间文字
            inputBox.style.opacity = 0; // 隐藏输入框
            inputBox.blur();
            
            statusText.style.color = "#888";
            statusText.innerText = "命运已定。请依次点击法阵，抽取过去、现在、未来。";
            
            // 改变法阵点击行为 -> 变成抽牌
            trigger.onclick = distributeCard;
            // 移除长按监听
            trigger.removeEventListener('mousedown', startChanneling);
            trigger.removeEventListener('touchstart', startChanneling);
        }

        // --- 龙卷风特效逻辑 ---
        function createTornado() {
            // 清空旧的
            tornadoCon.innerHTML = '';
            state.tornadoCards = [];

            // 生成 24 张小牌
            for (let i = 0; i < 24; i++) {
                const card = document.createElement('div');
                card.className = 'storm-card';
                tornadoCon.appendChild(card);
                state.tornadoCards.push(card);

                // 随机参数
                const delay = Math.random() * 0.5;
                const angle = (i / 24) * 360 + Math.random() * 30; // 环形分布
                const height = (Math.random() - 0.5) * 200; // 高度分布
                const radius = 100 + Math.random() * 50; // 半径

                // 强制重绘
                card.offsetHeight;

                // 激活飞出动画 (CSS Transition)
                setTimeout(() => {
                    card.style.opacity = 0.8;
                    // 使用 transform 组合：旋转角度 + 撑开半径 + 垂直高度
                    card.style.transform = `rotateY(${angle}deg) translateZ(${radius}px) translateY(${height}px)`;
                }, delay * 100);
            }
        }

        function destroyTornado() {
            // 所有卡片吸回中心
            state.tornadoCards.forEach((card, i) => {
                setTimeout(() => {
                    card.style.transform = `rotateY(0deg) translateZ(0px) translateY(0px) scale(0.1)`;
                    card.style.opacity = 0;
                }, i * 20); // 错落收回
            });

            // 1秒后清理 DOM
            setTimeout(() => {
                tornadoCon.innerHTML = '';
            }, 1500);
        }

        // 锁定数据
        function lockDestiny() {
            const shuffled = [...TAROT_DATA].sort(() => 0.5 - Math.random());
            state.selectedCards = [shuffled[0], shuffled[1], shuffled[2]];
            state.destinyLocked = true;
            
            // 显示空卡槽
            document.getElementById('slots-area').style.opacity = 1;
        }

        // 发牌 (点击法阵触发)
        function distributeCard() {
            if (state.currentSlot > 2) return;

            const index = state.currentSlot;
            const targetSlot = document.getElementById(`slot-${index}`);
            const cardData = state.selectedCards[index];

            // 创建飞行卡片
            const card = document.createElement('div');
            card.className = 'flying-card';
            
            let skin = 'default';
            if (index === 0) skin = 'moon';
            if (index === 1) skin = 'star';
            if (index === 2) skin = 'sun';

            card.innerHTML = `
                <div class="face back ${skin}"></div>
                <div class="face front" style="background-image: url('${cardData.img}'); background-size: cover; background-position: center;">
                    <div class="front-content">
                        <div class="card-name">${cardData.name}</div>
                        <div class="card-keywords">${cardData.keywords}</div>
                    </div>
                </div>
            `;

            // 起点：法阵中心
            const startRect = trigger.getBoundingClientRect();
            // 修正居中
            const startX = startRect.left + startRect.width/2 - 40; // 40是卡宽的一半
            const startY = startRect.top + startRect.height/2 - 70; // 70是卡高的一半

            card.style.left = startX + 'px';
            card.style.top = startY + 'px';
            document.body.appendChild(card);

            // 终点：卡槽
            const endRect = targetSlot.getBoundingClientRect();
            // 卡槽和卡片尺寸一致，直接对齐 left/top
            const endX = endRect.left; 
            const endY = endRect.top;

            // 强制重绘后执行移动
            requestAnimationFrame(() => {
                card.style.transform = `translate(${endX - startX}px, ${endY - startY}px)`;
            });

            // 绑定点击揭开
            card.onclick = () => revealCard(card, index);

            state.currentSlot++;
            if (state.currentSlot > 2) {
                statusText.innerText = "请点击卡片，揭开真相。";
                // 此时法阵消失或淡出，把舞台留给卡片
                trigger.style.opacity = 0.5;
                trigger.style.pointerEvents = 'none';
            }
        }

        // 揭开 (聚焦模式)
        function revealCard(cardEl, index) {
            if (cardEl.classList.contains('revealed')) return;

            cardEl.classList.add('zoomed');
            document.getElementById('mask').style.opacity = 1;

            cardEl.onclick = (e) => {
                e.stopPropagation();
                returnCard(cardEl);
            };
        }

        function returnCard(cardEl) {
            cardEl.classList.remove('zoomed');
            cardEl.classList.add('revealed');
            document.getElementById('mask').style.opacity = 0;
            cardEl.onclick = null; // 归位后不可点

            state.cardsRevealed++;
            if (state.cardsRevealed === 3) {
                showSynthesis();
            }
        }

        function showSynthesis() {
            setTimeout(() => {
                const panel = document.getElementById('final-panel');
                panel.style.transform = 'translateY(0)';
                
                const aiText = `命运的齿轮已经咬合。过去的【${state.selectedCards[0].name}】暗示了你潜意识的积淀，这直接导致了现在【${state.selectedCards[1].name}】的局面。而未来的【${state.selectedCards[2].name}】正在向你招手，只要你保持目前的觉知，答案自会显现。`;
                typeWriter(aiText, document.getElementById('ai-text'));
            }, 800);
        }

        function typeWriter(text, element) {
            element.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 50);
                }
            }
            type();
        }
    </script>
</body>
</html>
