<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DESTINY PROTOCOL V25 MAGIC CIRCLE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">

    <style>
        /* 强制重置 */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { -webkit-text-size-adjust: 100%; }

        :root {
            --void-bg: #050505;
            --card-w: 135px; --card-h: 240px; /* PC */
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.5);
            --neon: #9d00ff;
        }

        /* 手机端物理尺寸 */
        @media (max-width: 768px) {
            :root { --card-w: 110px; --card-h: 195px; }
        }

        body {
            margin: 0; background-color: var(--void-bg); color: white;
            font-family: 'Noto Serif SC', serif; 
            overflow: hidden; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            perspective: 1000px;
        }

        .bg-gradient {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 80%);
            z-index: -1;
        }

        /* UI层 */
        .intro-layer { position: absolute; z-index: 100; display: flex; flex-direction: column; align-items: center; width: 100%; transition: opacity 0.8s; }
        
        /* --- 修改点 3：全新的旋转魔法阵 --- */
        .magic-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            margin-bottom: 40px;
            /* 外圈：紫色光晕和虚线 */
            border: 2px dashed var(--neon);
            box-shadow: 0 0 30px var(--neon), inset 0 0 20px var(--neon);
            display: flex; justify-content: center; align-items: center;
            animation: rotateCircleSlow 20s linear infinite;
            background: radial-gradient(circle, transparent 60%, rgba(157, 0, 255, 0.2));
        }

        /* 中圈：金色符文圈 (反向旋转) */
        .magic-circle::before {
            content: ''; position: absolute;
            width: 85%; height: 85%;
            border-radius: 50%;
            border: 1px solid var(--gold);
            /* 使用复杂的边框模拟符文刻度 */
            border-top: 3px double var(--gold);
            border-bottom: 3px double var(--gold);
            box-shadow: inset 0 0 15px var(--gold-dim);
            animation: rotateCircleFast 12s linear infinite reverse;
        }

        /* 内核：能量核心 (脉冲) */
        .magic-circle::after {
            content: ''; position: absolute;
            width: 40%; height: 40%;
            border-radius: 50%;
            background: radial-gradient(circle at center, var(--gold), var(--neon) 70%, transparent);
            box-shadow: 0 0 20px var(--gold), 0 0 40px var(--neon);
            animation: pulseCore 2s ease-in-out infinite alternate;
        }

        /* 魔法阵动画定义 */
        @keyframes rotateCircleSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateCircleFast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseCore { 0% { transform: scale(0.9); opacity: 0.7; } 100% { transform: scale(1.1); opacity: 1; } }
        /* ---------------------------------- */


        .input-group { width: 280px; text-align: center; }
        
        input { 
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 160, 89, 0.3); 
            /* --- 修改点 1：圆角收敛 --- */
            border-radius: 10px; 
            color: var(--gold); padding: 15px 0; text-align: center; outline: none; margin-bottom: 25px; font-family: 'Noto Serif SC', serif; 
        }
        
        button { 
            background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 12px 40px; 
            /* --- 修改点 1 & 2：圆角收敛，文字加大 --- */
            border-radius: 10px; 
            font-size: 18px;
            font-family: 'Noto Serif SC', serif; font-weight: 700; 
        }

        /* 3D 舞台 */
        .vortex-container { position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .card-ring { position: absolute; transform-style: preserve-3d; transition: transform 2s ease-out; }

        /* 卡片基础 */
        .tarot-card {
            position: absolute;
            width: var(--card-w); height: var(--card-h);
            left: calc(var(--card-w) / -2); top: calc(var(--card-h) / -2);
            border-radius: 8px; transform-style: preserve-3d;
            transition: transform 1s, opacity 1s;
            background-color: #222;
        }

        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 8px;
            overflow: hidden; 
            transition: background-image 0.3s;
        }

        .face.back {
            background-color: #111; border: 1px solid #444;
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.08) 25%, transparent 25%, transparent 75%, rgba(197, 160, 89, 0.08) 75%), linear-gradient(45deg, rgba(197, 160, 89, 0.08) 25%, transparent 25%, transparent 75%, rgba(197, 160, 89, 0.08) 75%);
            background-position: 0 0, 10px 10px; background-size: 20px 20px; background-repeat: repeat;
        }
        .face.back.has-skin { background-size: cover !important; background-repeat: no-repeat !important; border: none; }
        .face.front { transform: rotateY(180deg); background-color: #000; background-size: cover; background-position: center; }

        /* --- V21 字体排版系统 (Typography System) --- */
        .content-overlay {
            background: rgba(0, 0, 0, 0.85);
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s;
            box-shadow: inset 0 0 0 1px var(--gold-dim);
            outline: 1px solid rgba(212, 175, 55, 0.6);
            /* 电脑端默认 */
            padding: 20px;
        }
        .face.front.loaded .content-overlay { opacity: 1; }

        /* 电脑端排版 */
        .title-group { text-align: center; margin-bottom: 20px; width: 100%; border-bottom: 1px solid var(--gold-dim); padding-bottom: 10px; }
        .roman-num { font-family: 'Cinzel', serif; color: var(--gold-dim); font-size: 10px; display: block; margin-bottom: 5px; }
        .main-title { color: var(--gold); font-size: 20px; font-weight: 700; margin: 0; letter-spacing: 2px; }
        .sub-title { font-family: 'Cinzel', serif; color: #888; font-size: 8px; margin-top: 5px; display: block; letter-spacing: 1px; }
        .desc-text { color: #ddd; font-size: 10px; line-height: 1.8; text-align: justify; margin: 0; padding-top: 10px; }

        /* --- 手机端排版重构 (Mobile Typography Fix) --- */
        @media (max-width: 768px) {
            .content-overlay { 
                padding: 12px; /* 边距适中 */
                outline-offset: -4px; 
            }

            .title-group {
                margin-bottom: 8px;
                padding-bottom: 6px;
                border-bottom-width: 0.5px;
            }

            /* 技巧：不要写 3px, 4px，写大一点然后 scale 下去，保证清晰 */
            .roman-num { 
                font-size: 6px; 
                margin-bottom: 2px; 
                opacity: 0.8;
            }

            /* 标题：必须显著大 */
            .main-title { 
                font-size: 12px; /* 放大后约 31px，足够醒目 */
                line-height: 1.2;
                letter-spacing: 1px;
            }

            /* 英文：必须显著小 */
            .sub-title {
                font-size: 4px; /* 放大后约 10px */
                margin-top: 2px;
                opacity: 0.6;
            }

            /* 正文：黄金比例 */
            .desc-text {
                font-size: 5px; /* 放大后约 13px，阅读舒适 */
                line-height: 1.6;
                color: #ececec;
            }
        }

        /* 动画与交互 */
        .tarot-card.vanish { opacity: 0; transform: translate3d(0, 500px, -1000px) rotateX(45deg) !important; }
        .tarot-card.chosen { pointer-events: auto; cursor: pointer; box-shadow: 0 0 30px rgba(197, 160, 89, 0.2); transition: transform 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.5s; z-index: 999; }
        
        .tarot-card.flipped { z-index: 1000 !important; box-shadow: 0 0 100px var(--neon); transform: translate3d(0, 0, 400px) rotateY(180deg) scale(1.5) !important; }
        @media (max-width: 768px) {
            .tarot-card.flipped { transform: translate3d(0, 0, 220px) rotateY(180deg) scale(2.6) !important; }
        }

        .hidden { opacity: 0; pointer-events: none; }

        /* 错误弹窗 */
        #error-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 99999;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; padding: 20px;
        }
        #error-text { color: red; font-family: monospace; font-size: 12px; background: #111; padding: 10px; border: 1px solid red; width: 100%; overflow: scroll; height: 50%; }
        #close-err { margin-top: 20px; padding: 10px 30px; background: white; color: black; border: none; }
    </style>
</head>
<body>

    <div id="error-modal">
        <h3 style="color:white">API 连接失败</h3>
        <div id="error-text"></div>
        <button id="close-err" onclick="document.getElementById('error-modal').style.display='none'">关闭并重试</button>
    </div>

    <div class="bg-gradient" id="main-bg"></div>

    <div class="intro-layer" id="intro-ui">
        <div class="magic-circle"></div>
        
        <div class="input-group">
            <input type="text" id="user-input" placeholder="输入所求之事..." autocomplete="off">
            <button onclick="startRitual()">开启法阵</button>
        </div>
    </div>

    <div class="vortex-container" id="vortex-con">
        <div class="card-ring" id="card-ring"></div>
    </div>

    <script>
        const cardRing = document.getElementById('card-ring');
        const introUi = document.getElementById('intro-ui');
        const mainBg = document.getElementById('main-bg');
        const isMobile = window.innerWidth < 768;
        const TOTAL_CARDS = isMobile ? 12 : 24; 
        
        let allCards = [];
        let pendingAiResult = null; 
        let activeFlippedCard = null; 

        const SKINS = {
            MOON: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.png", 
            STAR: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.png", 
            SUN:  "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.png"  
        };

        // 显示错误弹窗
        function showError(msg) {
            document.getElementById('error-modal').style.display = 'flex';
            document.getElementById('error-text').innerText = msg;
        }

        async function preFetchAiResult(query) {
            try {
                const response = await fetch('/api/tarot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                
                // 解析返回结果（包含 raw 字符串）
                const jsonResp = await response.json();

                if (response.status !== 200) {
                    throw new Error(`API Error ${response.status}: ${jsonResp.error || 'Unknown Error'}`);
                }

                // 核心修复：手动清洗 JSON，防止 AI 返回 Markdown
                let rawContent = jsonResp.raw || "";
                // 删掉 ```json 和 ``` 
                let cleanContent = rawContent.replace(/```json/g, "").replace(/```/g, "").trim();
                
                let finalData;
                try {
                    finalData = JSON.parse(cleanContent);
                } catch (parseErr) {
                    throw new Error("JSON 解析失败，AI 返回了脏数据:\n" + cleanContent);
                }

                pendingAiResult = finalData;

                if (activeFlippedCard) {
                    renderCardContent(activeFlippedCard, finalData);
                }

            } catch (e) {
                console.error(e);
                showError(e.message); // 弹窗报错
                
                // 失败状态显示
                pendingAiResult = {
                    id: "ERR",
                    title: "连接中断",
                    enTitle: "CONNECTION ERROR",
                    desc: "无法解析命运信号。请检查 API 配置或重试。"
                };
                if (activeFlippedCard) renderCardContent(activeFlippedCard, pendingAiResult);
            }
        }

        function startRitual() {
            const query = document.getElementById('user-input').value;
            if(!query) return alert("心诚则灵...");
            introUi.classList.add('hidden');
            preFetchAiResult(query);
            generateVortex();
        }

        function generateVortex() {
            const radius = isMobile ? 220 : 550; 
            const zPush = isMobile ? -350 : 0; 
            const yJitter = isMobile ? 180 : 300; 
            if(isMobile) cardRing.style.transform = `translateZ(${zPush}px)`;

            for(let i=0; i<TOTAL_CARDS; i++) {
                const card = document.createElement('div');
                card.className = 'tarot-card';
                card.innerHTML = `<div class="face back"></div><div class="face front"><div class="content-overlay"></div></div>`;
                card.style.transform = `translate3d(0, 800px, -2000px)`; 
                cardRing.appendChild(card);
                allCards.push(card);

                setTimeout(() => {
                    const angle = (360 / TOTAL_CARDS) * i;
                    const randomY = (Math.random() - 0.5) * yJitter; 
                    card.style.opacity = 1;
                    card.style.transform = `rotateY(${angle}deg) translateZ(${radius}px) translateY(${randomY}px)`;
                }, 100 + (i * 30));
            }
            setTimeout(performSelection, 3000);
        }

        function performSelection() {
            const step = Math.floor(TOTAL_CARDS / 3);
            const indices = [0, step, step * 2];
            const chosenCards = indices.map(i => allCards[i]);

            allCards.forEach((card, idx) => { if(!indices.includes(idx)) card.classList.add('vanish'); });
            chosenCards.forEach((card) => {
                card.style.transition = 'transform 0.4s ease-in'; 
                card.style.transform = `translate3d(0, 0, -2000px) rotateY(0deg)`;
            });

            setTimeout(() => {
                chosenCards.forEach((card, i) => {
                    const spread = isMobile ? 130 : 200;
                    let xPos = 0; if(i === 0) xPos = -spread; if(i === 2) xPos = spread;
                    card.offsetHeight; 
                    card.className = 'tarot-card chosen'; 
                    let rotY = 0; if(i === 0) rotY = 10; if(i === 2) rotY = -10;

                    const zPop = isMobile ? 120 : 200; 
                    card.style.transform = `translate3d(${xPos}px, ${isMobile?-50:0}px, ${zPop}px) rotateY(${rotY}deg) scale(1.0)`;
                    
                    const backFace = card.querySelector('.face.back');
                    const frontFace = card.querySelector('.face.front');
                    let skinUrl = [SKINS.MOON, SKINS.STAR, SKINS.SUN][i];
                    
                    const img = new Image();
                    img.onload = () => {
                        backFace.classList.add('has-skin');
                        backFace.style.backgroundImage = `url('${skinUrl}')`;
                        frontFace.style.backgroundImage = `url('${skinUrl}')`;
                    };
                    img.src = skinUrl;
                    card.onclick = () => revealContent(card);
                });
            }, 500); 
        }

        function renderCardContent(card, data) {
            const overlay = card.querySelector('.content-overlay');
            const frontFace = card.querySelector('.face.front');
            
            const roman = data.id || "??";
            const title = data.title || "未知";
            const enTitle = data.enTitle || "";
            const desc = data.desc || "......";

            overlay.innerHTML = `
                <div class="title-group">
                    <span class="roman-num">${roman}</span>
                    <h3 class="main-title">${title}</h3>
                    <span class="sub-title">${enTitle}</span>
                </div>
                <p class="desc-text">${desc}</p>
            `;
            frontFace.classList.add('loaded');
        }

        function revealContent(card) {
            if(card.classList.contains('flipped')) return;
            activeFlippedCard = card; 
            mainBg.style.opacity = '0.3'; 
            document.querySelectorAll('.chosen').forEach(c => { if(c !== card) { c.style.opacity = 0; c.style.pointerEvents = 'none'; }});

            if (pendingAiResult) {
                renderCardContent(card, pendingAiResult);
            } else {
                const overlay = card.querySelector('.content-overlay');
                const frontFace = card.querySelector('.face.front');
                overlay.innerHTML = `
                    <div class="title-group">
                        <span class="roman-num">...</span>
                        <h3 class="main-title">连接中</h3>
                        <span class="sub-title">CONNECTING</span>
                    </div>
                    <p class="desc-text" style="text-align:center">正在建立量子链接...</p>
                `;
                frontFace.classList.add('loaded');
            }
            card.classList.add('flipped');
        }
    </script>
</body>
</html>
