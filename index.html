<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DESTINY PROTOCOL V3.5 (RE-VIEWABLE)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background-color: #050505; color: white;
            font-family: 'Noto Serif SC', serif; 
            display: flex; flex-direction: column; align-items: center;
            perspective: 1200px;
        }

        :root {
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.5);
            --neon: #9d00ff;
            --card-w-mobile: 80px; 
            --card-h-mobile: 140px;
            --card-w-zoom: 240px;
            --card-h-zoom: 420px;
        }

        .bg-gradient {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%);
            z-index: -1;
        }

        /* --- 区域 1: 舞台中心 (上方 60%) --- */
        .stage-area {
            flex: 60; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; /* 垂直居中，适合放最终文字 */
            align-items: center;
            position: relative; z-index: 10;
            padding: 20px;
        }

        /* 魔法阵容器 */
        .magic-circle-container {
            position: absolute; /* 绝对定位，方便隐藏 */
            width: 160px; height: 160px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 20;
            transition: all 0.8s ease; /* 平滑淡出 */
        }
        .magic-circle-container:active { transform: scale(0.95); }

        .magic-circle {
            width: 100%; height: 100%; border-radius: 50%; position: absolute;
            border: 2px dashed var(--neon); box-shadow: 0 0 30px var(--neon), inset 0 0 20px var(--neon);
            animation: rotateSlow 20s linear infinite;
            background: radial-gradient(circle, transparent 60%, rgba(157, 0, 255, 0.2));
            transition: all 0.5s;
        }
        .magic-circle.active {
            box-shadow: 0 0 80px var(--neon), inset 0 0 50px var(--neon);
            border-color: #fff;
            animation: rotateFast 0.5s linear infinite; 
        }
        .magic-circle::before {
            content: ''; position: absolute; width: 85%; height: 85%; border-radius: 50%;
            border: 1px solid var(--gold); border-top: 3px double var(--gold); border-bottom: 3px double var(--gold);
            top: 7.5%; left: 7.5%;
            animation: rotateSlow 12s linear infinite reverse;
        }

        .circle-hint {
            position: absolute; color: var(--gold); font-size: 14px; font-weight: bold;
            text-align: center; pointer-events: none; letter-spacing: 2px;
            text-shadow: 0 0 10px black;
            animation: pulseText 2s infinite;
        }

        /* 龙卷风容器 */
        .tornado-wrapper {
            position: absolute; width: 100%; height: 100%;
            top: 0; left: 0; pointer-events: none;
            transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
            z-index: 15;
        }
        .storm-card {
            position: absolute; width: 60px; height: 100px;
            background: #111; border: 1px solid var(--gold); border-radius: 4px;
            background-image: linear-gradient(45deg, rgba(212, 175, 55, 0.15) 25%, transparent 25%, transparent 75%, rgba(212, 175, 55, 0.15) 75%), 
                              linear-gradient(45deg, rgba(212, 175, 55, 0.15) 25%, transparent 25%, transparent 75%, rgba(212, 175, 55, 0.15) 75%);
            background-size: 10px 10px;
            box-shadow: 0 0 15px rgba(157, 0, 255, 0.3);
            opacity: 0; transition: opacity 0.3s, transform 0.1s;
        }

        /* 悬浮牌堆 */
        .deck-stack {
            position: absolute; width: 80px; height: 140px;
            z-index: 25; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .deck-card-static {
            position: absolute; width: 100%; height: 100%;
            background: #111; border: 1px solid var(--gold-dim); border-radius: 6px;
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%);
            background-size: 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* 输入框容器 */
        .controls-wrapper {
            position: absolute; top: 65%; /* 放在法阵下方 */
            width: 100%; display: flex; flex-direction: column; align-items: center;
            transition: all 0.5s ease;
        }
        .input-box {
            width: 260px; background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 8px; color: var(--gold); padding: 12px; text-align: center; outline: none; 
            font-family: 'Noto Serif SC', serif;
        }
        .status-text {
            margin-top: 15px; color: #888; font-size: 12px; letter-spacing: 1px;
            height: 20px; transition: opacity 0.3s;
        }

        /* --- 新增：顶部命运回响显示区 (替代原来的法阵位置) --- */
        .final-display {
            position: absolute; top: 10%; width: 90%; max-width: 600px;
            text-align: center; opacity: 0; pointer-events: none;
            transition: opacity 1s ease; z-index: 30;
        }
        .final-title { 
            color: var(--neon); font-family: 'Cinzel'; font-size: 20px; letter-spacing: 6px; 
            margin-bottom: 20px; text-shadow: 0 0 10px var(--neon);
        }
        .final-text { 
            color: #eee; font-size: 16px; line-height: 1.8; text-align: justify; 
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;
            border: 1px solid rgba(157, 0, 255, 0.2);
        }

        /* --- 区域 2: 底部卡槽 --- */
        .slots-container {
            flex: 40; width: 100%;
            display: flex; justify-content: space-evenly; align-items: flex-start;
            padding-top: 10px;
            opacity: 0; pointer-events: none; transition: opacity 1s;
        }
        .slot {
            width: var(--card-w-mobile); height: var(--card-h-mobile);
            border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px;
            position: relative;
        }
        .slot::after {
            content: attr(data-label);
            position: absolute; bottom: -25px; width: 100%; text-align: center;
            color: #444; font-size: 10px; font-family: 'Cinzel'; letter-spacing: 2px;
        }

        /* --- 动态元素 --- */
        .flying-card {
            position: fixed; width: var(--card-w-mobile); height: var(--card-h-mobile);
            border-radius: 6px; transform-style: preserve-3d;
            transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50; cursor: pointer;
        }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; overflow: hidden; }
        
        .back { background-color: #111; background-size: cover; background-position: center; border: 1px solid #444; }
        .back.default { background-image: linear-gradient(45deg, #222 25%, #111 25%), linear-gradient(-45deg, #222 25%, #111 25%); background-size: 4px 4px; }
        .back.moon { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.png'); }
        .back.star { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.png'); }
        .back.sun  { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.png'); }

        .front { 
            transform: rotateY(180deg); background: #000; 
            display: flex; flex-direction: column; justify-content: flex-end;
            box-shadow: inset 0 0 0 1px var(--gold-dim);
        }
        .front-content {
            padding: 8px; text-align: center; background: rgba(0,0,0,0.9);
            border-top: 1px solid var(--gold-dim); backdrop-filter: blur(4px);
        }
        .card-name { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .card-keywords { color: #aaa; font-size: 10px; transform: scale(0.9); white-space: nowrap; }

        .overlay-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 90;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .flying-card.zoomed {
            width: var(--card-w-zoom) !important; height: var(--card-h-zoom) !important;
            z-index: 100;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) rotateY(180deg) !important;
            box-shadow: 0 0 60px rgba(157, 0, 255, 0.4);
        }
        .flying-card.zoomed .card-name { font-size: 24px; margin-bottom: 10px; }
        .flying-card.zoomed .card-keywords { font-size: 14px; color: #fff; transform: scale(1); white-space: normal; }

        @keyframes rotateSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateFast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="bg-gradient"></div>
    <div class="overlay-mask" id="mask"></div>

    <div class="stage-area">
        <div class="tornado-wrapper" id="tornado-con"></div>

        <div class="magic-circle-container" id="magic-trigger">
            <div class="magic-circle" id="magic-ring"></div>
            <div class="circle-hint" id="circle-text">长按<br>注入能量</div>
        </div>

        <div class="deck-stack" id="deck-stack">
            <div class="deck-card-static" style="transform: translateZ(0px)"></div>
            <div class="deck-card-static" style="transform: translateZ(2px) rotate(2deg)"></div>
            <div class="deck-card-static" style="transform: translateZ(4px) rotate(-1deg)"></div>
            <div class="deck-card-static" style="transform: translateZ(6px) rotate(1deg)"></div>
        </div>

        <div class="controls-wrapper" id="controls">
            <input type="text" class="input-box" id="user-input" placeholder="输入所求之事..." autocomplete="off">
            <div class="status-text" id="status-text"></div>
        </div>

        <div class="final-display" id="final-con">
            <div class="final-title">✧ 命运回响 ✧</div>
            <div class="final-text" id="ai-text"></div>
        </div>
    </div>

    <div class="slots-container" id="slots-area">
        <div class="slot" id="slot-0" data-label="PAST"></div>
        <div class="slot" id="slot-1" data-label="PRESENT"></div>
        <div class="slot" id="slot-2" data-label="FUTURE"></div>
    </div>

    <script>
        const TAROT_DATA = [
            { id: "0", name: "愚者", en: "The Fool", keywords: "新的开始 · 冒险 · 纯真", img: "https://upload.wikimedia.org/wikipedia/commons/9/90/RWS_Tarot_00_Fool.jpg" },
            { id: "I", name: "魔术师", en: "The Magician", keywords: "创造力 · 意志 · 显化", img: "https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg" },
            { id: "II", name: "女祭司", en: "The High Priestess", keywords: "直觉 · 神秘 · 潜意识", img: "https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg" },
            { id: "III", name: "女皇", en: "The Empress", keywords: "丰饶 · 母性 · 自然", img: "https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg" },
            { id: "IV", name: "皇帝", en: "The Emperor", keywords: "权威 · 结构 · 控制", img: "https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg" },
            { id: "V", name: "教皇", en: "The Hierophant", keywords: "传统 · 信仰 · 学习", img: "https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg" },
            { id: "VI", name: "恋人", en: "The Lovers", keywords: "关系 · 选择 · 和谐", img: "https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg" },
            { id: "VII", name: "战车", en: "The Chariot", keywords: "行动 · 胜利 · 意志力", img: "https://upload.wikimedia.org/wikipedia/commons/9/9b/RWS_Tarot_07_Chariot.jpg" },
            { id: "VIII", name: "力量", en: "Strength", keywords: "勇气 · 耐心 · 同情", img: "https://upload.wikimedia.org/wikipedia/commons/f/f5/RWS_Tarot_08_Strength.jpg" },
            { id: "IX", name: "隐士", en: "The Hermit", keywords: "内省 · 孤独 · 指引", img: "https://upload.wikimedia.org/wikipedia/commons/4/4d/RWS_Tarot_09_Hermit.jpg" },
            { id: "X", name: "命运之轮", en: "Wheel of Fortune", keywords: "流转 · 机遇 · 宿命", img: "https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg" },
            { id: "XI", name: "正义", en: "Justice", keywords: "公平 · 真理 · 因果", img: "https://upload.wikimedia.org/wikipedia/commons/e/e0/RWS_Tarot_11_Justice.jpg" },
            { id: "XII", name: "倒吊人", en: "The Hanged Man", keywords: "牺牲 · 等待 · 新视角", img: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg" },
            { id: "XIII", name: "死神", en: "Death", keywords: "结束 · 转变 · 重生", img: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg" },
            { id: "XIV", name: "节制", en: "Temperance", keywords: "平衡 · 治愈 · 融合", img: "https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg" },
            { id: "XV", name: "恶魔", en: "The Devil", keywords: "束缚 · 欲望 · 物质", img: "https://upload.wikimedia.org/wikipedia/commons/5/55/RWS_Tarot_15_Devil.jpg" },
            { id: "XVI", name: "高塔", en: "The Tower", keywords: "崩塌 · 启示 · 突变", img: "https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_16_Tower.jpg" },
            { id: "XVII", name: "星星", en: "The Star", keywords: "希望 · 灵感 · 宁静", img: "https://upload.wikimedia.org/wikipedia/commons/d/db/RWS_Tarot_17_Star.jpg" },
            { id: "XVIII", name: "月亮", en: "The Moon", keywords: "幻觉 · 不安 · 潜意识", img: "https://upload.wikimedia.org/wikipedia/commons/7/7f/RWS_Tarot_18_Moon.jpg" },
            { id: "XIX", name: "太阳", en: "The Sun", keywords: "成功 · 喜悦 · 活力", img: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg" },
            { id: "XX", name: "审判", en: "Judgement", keywords: "觉醒 · 召唤 · 新生", img: "https://upload.wikimedia.org/wikipedia/commons/d/dd/RWS_Tarot_20_Judgement.jpg" },
            { id: "XXI", name: "世界", en: "The World", keywords: "圆满 · 完成 · 旅程", img: "https://upload.wikimedia.org/wikipedia/commons/f/ff/RWS_Tarot_21_World.jpg" }
        ];

        let state = {
            shuffling: false,
            destinyLocked: false,
            selectedCards: [],
            currentSlot: 0,
            cardsRevealed: 0,
            tornadoCards: [],
            animationFrame: null
        };

        const trigger = document.getElementById('magic-trigger');
        const ring = document.getElementById('magic-ring');
        const circleText = document.getElementById('circle-text');
        const tornadoCon = document.getElementById('tornado-con');
        const inputBox = document.getElementById('user-input');
        const statusText = document.getElementById('status-text');
        const deckStack = document.getElementById('deck-stack');
        const controls = document.getElementById('controls');
        const finalCon = document.getElementById('final-con');

        trigger.addEventListener('mousedown', startChanneling);
        trigger.addEventListener('touchstart', (e) => { e.preventDefault(); startChanneling(); });
        
        trigger.addEventListener('mouseup', stopChanneling);
        trigger.addEventListener('touchend', stopChanneling);

        function startChanneling() {
            if (state.destinyLocked) return;
            const query = inputBox.value;
            if (!query) {
                statusText.innerText = "请先输入心中的疑惑...";
                statusText.style.color = "#ff4444";
                return;
            }

            state.shuffling = true;
            ring.classList.add('active');
            circleText.innerText = "能量注入中...";
            statusText.innerText = "";
            createTornado();
        }

        function stopChanneling() {
            if (!state.shuffling) return;
            state.shuffling = false;
            ring.classList.remove('active');
            cancelAnimationFrame(state.animationFrame);

            lockDestiny(); 
            destroyTornado();
        }

        function createTornado() {
            tornadoCon.innerHTML = '';
            state.tornadoCards = [];
            
            for (let i = 0; i < 36; i++) {
                const card = document.createElement('div');
                card.className = 'storm-card';
                tornadoCon.appendChild(card);
                
                const t = {
                    el: card,
                    angle: (i / 36) * 360,
                    y: (Math.random() - 0.5) * 600,
                    radius: 120 + Math.random() * 150,
                    speed: 2 + Math.random() * 3
                };
                state.tornadoCards.push(t);
                
                setTimeout(() => { card.style.opacity = 0.8; }, Math.random() * 200);
            }
            animateTornado();
        }

        function animateTornado() {
            if (!state.shuffling) return;
            state.tornadoCards.forEach(t => {
                t.angle += t.speed;
                t.el.style.transform = `translateY(${t.y}px) rotateY(${t.angle}deg) translateZ(${t.radius}px)`;
            });
            state.animationFrame = requestAnimationFrame(animateTornado);
        }

        function destroyTornado() {
            state.tornadoCards.forEach((t, i) => {
                t.el.style.transition = 'all 0.6s ease-in';
                t.el.style.transform = `translateY(0px) rotateY(${t.angle + 180}deg) translateZ(0px) scale(0.1)`;
                t.el.style.opacity = 0;
            });

            setTimeout(() => {
                tornadoCon.innerHTML = ''; 
                showDeckStack();
            }, 600);
        }

        function showDeckStack() {
            // 隐藏法阵和输入框，腾出空间
            trigger.style.opacity = 0; 
            trigger.style.pointerEvents = 'none';
            controls.style.opacity = 0; // 隐藏输入框容器

            deckStack.style.opacity = 1;
            
            setTimeout(() => {
                deckStack.style.pointerEvents = 'auto'; 
                deckStack.onclick = distributeCard;     
                
                statusText.style.color = "#888";
                statusText.innerText = "命运已定。请依次点击牌堆，抽取过去、现在、未来。";
                statusText.style.opacity = 1;
                // 将提示文字移动到合适位置 (因为controls被隐藏了，我们把提示挂在body或者单独显示)
                // 这里简单复用controls的位置，但因为opacity 0了，所以需要把 statusText 移出来或者单独处理
                // 为了简单，我们让 controls 保持结构，只隐藏 input-box
                controls.style.opacity = 1;
                inputBox.style.display = 'none';
            }, 500);
        }

        function lockDestiny() {
            const shuffled = [...TAROT_DATA].sort(() => 0.5 - Math.random());
            state.selectedCards = [shuffled[0], shuffled[1], shuffled[2]];
            state.destinyLocked = true;
            document.getElementById('slots-area').style.opacity = 1;
        }

        function distributeCard() {
            if (state.currentSlot > 2) return;

            const index = state.currentSlot;
            const targetSlot = document.getElementById(`slot-${index}`);
            const cardData = state.selectedCards[index];

            const card = document.createElement('div');
            card.className = 'flying-card';
            
            let skin = 'default';
            if (index === 0) skin = 'moon';
            if (index === 1) skin = 'star';
            if (index === 2) skin = 'sun';

            card.innerHTML = `
                <div class="face back ${skin}"></div>
                <div class="face front" style="background-image: url('${cardData.img}'); background-size: cover; background-position: center;">
                    <div class="front-content">
                        <div class="card-name">${cardData.name}</div>
                        <div class="card-keywords">${cardData.keywords}</div>
                    </div>
                </div>
            `;

            const startRect = deckStack.getBoundingClientRect();
            card.style.left = startRect.left + 'px';
            card.style.top = startRect.top + 'px';
            document.body.appendChild(card);

            const endRect = targetSlot.getBoundingClientRect();
            const endX = endRect.left; 
            const endY = endRect.top;

            requestAnimationFrame(() => {
                card.style.transform = `translate(${endX - startRect.left}px, ${endY - startRect.top}px)`;
            });

            card.onclick = () => revealCard(card, index);

            state.currentSlot++;
            if (state.currentSlot > 2) {
                deckStack.style.opacity = 0;
                deckStack.style.pointerEvents = 'none';
                statusText.innerText = "请点击卡片，揭开真相。";
            }
        }

        function revealCard(cardEl, index) {
            // 点击即放大，无视是否已揭开
            cardEl.classList.add('zoomed');
            document.getElementById('mask').style.opacity = 1;

            cardEl.onclick = (e) => {
                e.stopPropagation();
                returnCard(cardEl, index);
            };
        }

        function returnCard(cardEl, index) {
            cardEl.classList.remove('zoomed');
            cardEl.classList.add('revealed');
            document.getElementById('mask').style.opacity = 0;
            
            // 归位后，重新绑定点击事件，允许再次放大查看
            setTimeout(() => {
                cardEl.onclick = () => revealCard(cardEl, index);
            }, 300); // 略微延迟避免冲突

            state.cardsRevealed++;
            // 只有当第一次达到3张时触发结局
            if (state.cardsRevealed === 3 && !state.synthesisShown) {
                state.synthesisShown = true;
                showSynthesis();
            }
        }

        function showSynthesis() {
            // 清理舞台：隐藏提示语
            statusText.style.opacity = 0;
            
            // 显示顶部文字容器
            finalCon.style.opacity = 1;
            finalCon.style.pointerEvents = 'auto';

            const aiText = `命运的齿轮已经咬合。过去的【${state.selectedCards[0].name}】暗示了你潜意识的积淀，这直接导致了现在【${state.selectedCards[1].name}】的局面。而未来的【${state.selectedCards[2].name}】正在向你招手，只要你保持目前的觉知，答案自会显现。`;
            
            typeWriter(aiText, document.getElementById('ai-text'));
        }

        function typeWriter(text, element) {
            element.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 50);
                }
            }
            type();
        }
    </script>
</body>
</html>
