<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DESTINY PROTOCOL V3.1 (NO-AI)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { -webkit-text-size-adjust: 100%; }
        body { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background-color: #050505; color: white;
            font-family: 'Noto Serif SC', serif; 
            display: flex; flex-direction: column; align-items: center;
            perspective: 1000px;
        }

        :root {
            --gold: #d4af37;
            --gold-dim: rgba(212, 175, 55, 0.5);
            --neon: #9d00ff;
            /* 卡片尺寸定义 */
            --card-w-mobile: 90px; 
            --card-h-mobile: 155px;
            --card-w-zoom: 240px;
            --card-h-zoom: 420px;
        }

        .bg-gradient {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%);
            z-index: -1;
        }

        /* --- 1. 顶部魔法阵区域 --- */
        .stage-area {
            flex: 1; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative;
            z-index: 10; transition: transform 0.5s;
        }

        .magic-circle {
            width: 140px; height: 140px; border-radius: 50%; position: relative;
            border: 2px dashed var(--neon); box-shadow: 0 0 30px var(--neon), inset 0 0 20px var(--neon);
            display: flex; justify-content: center; align-items: center;
            animation: rotateSlow 20s linear infinite;
            background: radial-gradient(circle, transparent 60%, rgba(157, 0, 255, 0.2));
            transition: all 0.3s;
        }
        .magic-circle.active {
            box-shadow: 0 0 60px var(--neon), inset 0 0 40px var(--neon);
            animation: rotateFast 2s linear infinite; /* 加速旋转 */
        }
        .magic-circle::before {
            content: ''; position: absolute; width: 85%; height: 85%; border-radius: 50%;
            border: 1px solid var(--gold); border-top: 3px double var(--gold); border-bottom: 3px double var(--gold);
            animation: rotateSlow 12s linear infinite reverse;
        }

        /* 悬浮牌堆 */
        .deck-stack {
            position: absolute; width: 60px; height: 100px;
            transform-style: preserve-3d; cursor: pointer;
            transition: opacity 0.5s;
        }
        .deck-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; border: 1px solid #444; border-radius: 4px;
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%);
            background-size: 10px 10px;
            transition: transform 0.3s;
        }

        /* 输入与按钮 */
        .control-panel {
            position: absolute; bottom: 20%; width: 280px; text-align: center;
            transition: opacity 0.5s, transform 0.5s;
        }
        input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--gold-dim);
            border-radius: 8px; color: var(--gold); padding: 12px; text-align: center; outline: none; margin-bottom: 20px;
        }
        .ritual-btn {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 12px 40px; border-radius: 8px; font-size: 16px; font-weight: 700;
            user-select: none; touch-action: manipulation;
            transition: all 0.2s;
        }
        .ritual-btn:active { background: rgba(212, 175, 55, 0.2); transform: scale(0.95); }

        /* --- 2. 底部卡槽区域 (三位一体) --- */
        .slots-container {
            position: absolute; bottom: 30px; width: 100%; height: 180px;
            display: flex; justify-content: space-evenly; align-items: center;
            z-index: 20; opacity: 0; pointer-events: none;
            transition: opacity 1s;
        }
        .slot {
            width: var(--card-w-mobile); height: var(--card-h-mobile);
            border: 1px dashed rgba(255,255,255,0.2); border-radius: 6px;
            position: relative; perspective: 1000px;
        }
        .slot::after {
            content: attr(data-label);
            position: absolute; bottom: -25px; width: 100%; text-align: center;
            color: #666; font-size: 10px; font-family: 'Cinzel'; letter-spacing: 2px;
        }

        /* 飞行/落位的卡片 */
        .flying-card {
            position: fixed; width: var(--card-w-mobile); height: var(--card-h-mobile);
            border-radius: 6px; transform-style: preserve-3d;
            transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50; cursor: pointer;
        }
        
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; overflow: hidden; }
        
        /* 背面纹理系统 */
        .back { background-color: #111; background-size: cover; background-position: center; border: 1px solid #444; }
        .back.default { background-image: linear-gradient(45deg, #222 25%, #111 25%), linear-gradient(-45deg, #222 25%, #111 25%); background-size: 4px 4px; }
        .back.moon { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.png'); }
        .back.star { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.png'); }
        .back.sun  { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.png'); }

        .front { 
            transform: rotateY(180deg); background: #000; 
            display: flex; flex-direction: column; justify-content: flex-end;
            box-shadow: inset 0 0 0 1px var(--gold-dim);
        }
        .front-content {
            padding: 10px; text-align: center; background: rgba(0,0,0,0.85);
            border-top: 1px solid var(--gold-dim);
        }
        .card-name { color: var(--gold); font-size: 16px; font-weight: bold; margin-bottom: 4px; }
        .card-keywords { color: #ccc; font-size: 10px; opacity: 0.8; }

        /* --- 3. 聚焦模式 (Zoom Mode) --- */
        .overlay-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 90;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }
        .flying-card.zoomed {
            width: var(--card-w-zoom) !important; height: var(--card-h-zoom) !important;
            z-index: 100;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) rotateY(180deg) !important; /* 强制翻转 */
            box-shadow: 0 0 50px rgba(157, 0, 255, 0.5);
        }
        .flying-card.zoomed .card-name { font-size: 24px; margin-bottom: 10px; }
        .flying-card.zoomed .card-keywords { font-size: 14px; }

        /* --- 4. 命运回响面板 (Synthesis) --- */
        .synthesis-panel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #000 90%, transparent);
            padding: 30px 20px 50px; text-align: center;
            transform: translateY(100%); transition: transform 0.8s ease-out;
            z-index: 95;
        }
        .synthesis-title { color: var(--neon); font-family: 'Cinzel'; margin-bottom: 15px; font-size: 14px; letter-spacing: 2px; }
        .synthesis-text { color: #eee; font-size: 14px; line-height: 1.8; text-align: justify; max-height: 200px; overflow-y: auto; }

        /* 动画关键帧 */
        @keyframes rotateSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateFast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes chaosFly { 
            0% { transform: translate(0,0) rotate(0); }
            25% { transform: translate(30px, -40px) rotate(10deg); }
            50% { transform: translate(-20px, 20px) rotate(-5deg); }
            75% { transform: translate(10px, -10px) rotate(5deg); }
            100% { transform: translate(0,0) rotate(0); }
        }

        .helper-text {
            position: absolute; top: 120px; width: 100%; text-align: center;
            color: #888; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="bg-gradient"></div>
    <div class="overlay-mask" id="mask"></div>

    <div class="stage-area" id="stage">
        <div class="magic-circle" id="magic-circle"></div>
        
        <div class="deck-stack" id="deck-stack" style="opacity: 0;">
            <div class="deck-card" style="transform: translateZ(0px)"></div>
            <div class="deck-card" style="transform: translateZ(2px) rotate(2deg)"></div>
            <div class="deck-card" style="transform: translateZ(4px) rotate(-1deg)"></div>
        </div>

        <div class="control-panel" id="controls">
            <input type="text" id="user-input" placeholder="输入所求之事..." autocomplete="off">
            <button class="ritual-btn" id="action-btn" 
                onmousedown="startShuffle()" onmouseup="endShuffle()" 
                ontouchstart="startShuffle()" ontouchend="endShuffle()">
                按住注入能量
            </button>
        </div>
        
        <div class="helper-text" id="helper-text"></div>
    </div>

    <div class="slots-container" id="slots-area">
        <div class="slot" id="slot-0" data-label="PAST"></div>
        <div class="slot" id="slot-1" data-label="PRESENT"></div>
        <div class="slot" id="slot-2" data-label="FUTURE"></div>
    </div>

    <div class="synthesis-panel" id="final-panel">
        <div class="synthesis-title">✧ 命运回响 ✧</div>
        <div class="synthesis-text" id="ai-text">正在接收深空信号...</div>
    </div>

    <script>
        // --- 1. 本地数据库 (Local Database) ---
        const TAROT_DATA = [
            { id: "0", name: "愚者", en: "The Fool", keywords: "起点 · 自由 · 潜力", img: "https://upload.wikimedia.org/wikipedia/commons/9/90/RWS_Tarot_00_Fool.jpg" },
            { id: "I", name: "魔术师", en: "The Magician", keywords: "创造 · 力量 · 专注", img: "https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg" },
            { id: "II", name: "女祭司", en: "The High Priestess", keywords: "直觉 · 神秘 · 潜意识", img: "https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg" },
            { id: "III", name: "女皇", en: "The Empress", keywords: "丰饶 · 母性 · 自然", img: "https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg" },
            { id: "IV", name: "皇帝", en: "The Emperor", keywords: "权威 · 结构 · 稳固", img: "https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg" },
            { id: "IX", name: "隐士", en: "The Hermit", keywords: "内省 · 孤独 · 指引", img: "https://upload.wikimedia.org/wikipedia/commons/4/4d/RWS_Tarot_09_Hermit.jpg" },
            { id: "X", name: "命运之轮", en: "Wheel of Fortune", keywords: "流转 · 机遇 · 宿命", img: "https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg" },
            { id: "XII", name: "倒吊人", en: "The Hanged Man", keywords: "牺牲 · 等待 · 新视角", img: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg" },
            { id: "XIII", name: "死神", en: "Death", keywords: "结束 · 转变 · 重生", img: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg" },
            { id: "XIX", name: "太阳", en: "The Sun", keywords: "成功 · 喜悦 · 活力", img: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg" }
        ];

        // --- 2. 状态管理 ---
        let state = {
            shuffling: false,
            destinyLocked: false, // 是否已锁定结果
            selectedCards: [],    // 抽中的三张牌数据
            currentSlot: 0,       // 当前要填入哪个卡槽 (0,1,2)
            cardsRevealed: 0      // 已经翻开了几张
        };

        const magicCircle = document.getElementById('magic-circle');
        const deckStack = document.getElementById('deck-stack');
        const btn = document.getElementById('action-btn');
        const helper = document.getElementById('helper-text');
        
        // --- 3. 交互逻辑 ---

        // 阶段一：洗牌 (Shuffle)
        function startShuffle() {
            const query = document.getElementById('user-input').value;
            if(!query) return alert("请先输入心中的疑惑...");
            
            state.shuffling = true;
            magicCircle.classList.add('active');
            deckStack.style.opacity = 1;
            btn.innerText = "注入能量中...";
            
            // 模拟洗牌动画
            document.querySelectorAll('.deck-card').forEach(c => {
                c.style.animation = `chaosFly 0.5s infinite`;
            });
        }

        function endShuffle() {
            if(!state.shuffling) return;
            state.shuffling = false;
            magicCircle.classList.remove('active');
            
            // 锁定命运：随机抽3张
            lockDestiny(); 
            
            // UI 变更
            document.querySelectorAll('.deck-card').forEach(c => c.style.animation = 'none');
            document.getElementById('controls').style.opacity = 0; // 隐藏输入框
            document.getElementById('controls').style.pointerEvents = 'none';
            
            // 提示抽牌
            helper.innerText = "命运已定。请依次点击牌堆，抽取过去、现在、未来。";
            helper.style.opacity = 1;
            
            // 激活牌堆点击
            deckStack.onclick = distributeCard;
        }

        // 锁定命运 (本地随机)
        function lockDestiny() {
            // 简单的洗牌算法
            const shuffled = [...TAROT_DATA].sort(() => 0.5 - Math.random());
            state.selectedCards = [shuffled[0], shuffled[1], shuffled[2]];
            console.log("命运已锁定:", state.selectedCards.map(c => c.name));
            state.destinyLocked = true;
            
            // TODO: 这里将来会触发后端 API 请求
            document.getElementById('slots-area').style.opacity = 1; // 显示卡槽
        }

        // 阶段二：分发 (Distribute)
        function distributeCard() {
            if (state.currentSlot > 2) return;

            const cardIndex = state.currentSlot;
            const targetSlot = document.getElementById(`slot-${cardIndex}`);
            const cardData = state.selectedCards[cardIndex];
            
            // 1. 创建飞行卡片
            const card = document.createElement('div');
            card.className = 'flying-card';
            
            // 确定背纹皮肤
            let skinClass = 'default';
            if(cardIndex === 0) skinClass = 'moon';
            if(cardIndex === 1) skinClass = 'star';
            if(cardIndex === 2) skinClass = 'sun';

            card.innerHTML = `
                <div class="face back ${skinClass}"></div>
                <div class="face front" style="background-image: url('${cardData.img}'); background-size: cover; background-position: center;">
                    <div class="front-content">
                        <div class="card-name">${cardData.name}</div>
                        <div class="card-keywords">${cardData.keywords}</div>
                    </div>
                </div>
            `;

            // 2. 初始位置：设在牌堆中心
            const startRect = deckStack.getBoundingClientRect();
            card.style.left = startRect.left + 'px';
            card.style.top = startRect.top + 'px';
            
            document.body.appendChild(card);

            // 3. 飞行位置：设到目标卡槽
            // 强制重绘
            card.getBoundingClientRect();
            
            const endRect = targetSlot.getBoundingClientRect();
            // 计算居中偏移
            const x = endRect.left + (endRect.width - 90)/2; // 90是卡宽
            const y = endRect.top + (endRect.height - 155)/2; // 155是卡高

            card.style.transform = `translate(${x - startRect.left}px, ${y - startRect.top}px)`;

            // 4. 绑定点击揭开事件
            card.onclick = () => revealCard(card, cardIndex);

            // 更新状态
            state.currentSlot++;
            if(state.currentSlot > 2) {
                deckStack.style.opacity = 0; // 隐藏牌堆
                deckStack.style.pointerEvents = 'none';
                helper.innerText = "请依次点击卡片，揭开真相。";
            }
        }

        // 阶段三：聚焦揭秘 (Zoom Reveal)
        function revealCard(cardEl, index) {
            // 防止重复点击
            if(cardEl.classList.contains('revealed')) return;
            
            // 1. 放大并居中
            cardEl.classList.add('zoomed');
            document.getElementById('mask').style.opacity = 1;
            
            // 2. 归位逻辑 (点击放大后的卡片)
            cardEl.onclick = (e) => {
                e.stopPropagation();
                returnCard(cardEl, index);
            };
        }

        // 归位
        function returnCard(cardEl, index) {
            cardEl.classList.remove('zoomed');
            cardEl.classList.add('revealed'); // 标记已翻开
            document.getElementById('mask').style.opacity = 0;
            
            // 恢复点击事件为空 (归位后不能再点了，或者可以再次查看，看需求)
            cardEl.onclick = null; 

            state.cardsRevealed++;
            
            // 检查是否全部翻开
            if(state.cardsRevealed === 3) {
                showSynthesis();
            }
        }

        // 阶段四：最终解读
        function showSynthesis() {
            setTimeout(() => {
                const panel = document.getElementById('final-panel');
                panel.style.transform = 'translateY(0)';
                
                // 模拟打字机输出
                const aiText = `命运的齿轮已经咬合。过去的【${state.selectedCards[0].name}】暗示了你潜意识的积淀，这直接导致了现在【${state.selectedCards[1].name}】的局面。而未来的【${state.selectedCards[2].name}】正在向你招手，只要你保持目前的觉知，答案自会显现。`;
                
                typeWriter(aiText, document.getElementById('ai-text'));
            }, 1000);
        }

        // 打字机特效
        function typeWriter(text, element) {
            element.innerHTML = "";
            let i = 0;
            const speed = 50;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }
    </script>
</body>
</html>
