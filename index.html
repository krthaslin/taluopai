<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DESTINY PROTOCOL V5.20 FINAL</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+SC:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- 基础设置 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; 
            height: 100vh; 
            overflow: hidden; 
            background-color: #050505; color: white;
            font-family: 'Noto Serif SC', serif; 
            display: flex; flex-direction: column; align-items: center;
            perspective: 1200px;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        }

        :root {
            --gold: #d4af37;
            --gold-light: #fff8dc;
            --gold-dim: rgba(212, 175, 55, 0.5);
            --neon: #9d00ff;
            --mystic-red: #ff4444; 
            
            /* 移动端尺寸 */
            --card-w: 80px; --card-h: 140px;
            --card-w-zoom: 240px; --card-h-zoom: 420px;
            --storm-card-w: 60px; --storm-card-h: 100px;
        }

        @media (min-width: 768px) {
            :root {
                --card-w: 150px; --card-h: 260px;
                --card-w-zoom: 360px; --card-h-zoom: 630px;
                --storm-card-w: 100px; --storm-card-h: 160px;
            }
        }

        .bg-gradient {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%);
            z-index: -1;
        }

        /* --- 标题区 --- */
        .title-block {
            display: flex; flex-direction: column; width: fit-content; 
            position: relative; z-index: 100; pointer-events: none; align-items: center;
        }

        .cn-title {
            font-family: 'Noto Serif SC', serif; font-weight: 900; font-size: 16px; 
            width: 75%; margin: 0 auto 6px auto;
            display: flex; justify-content: space-between; 
            background: linear-gradient(110deg, #d4af37 20%, #fff8dc 50%, #d4af37 80%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
        }

        .main-title {
            font-family: 'Cinzel Decorative', cursive; font-size: 42px; font-weight: 700; line-height: 1;
            background: linear-gradient(180deg, #fff8dc 20%, #d4af37 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(157, 0, 255, 0.3), 0 0 10px rgba(212, 175, 55, 0.2);
            letter-spacing: 8px; margin: 0; padding: 0; margin-right: -8px; white-space: nowrap; 
        }

        @media (max-width: 768px) {
            .title-block { width: 90vw; max-width: 320px; }
            .main-title { font-size: 24px; letter-spacing: 3px; margin-right: -3px; }
            .cn-title { font-size: 11px; margin-bottom: 4px; }
        }

        @keyframes shine { to { background-position: 200% center; } }

        /* --- Powered By --- */
        .powered-container {
            display: flex; align-items: center; justify-content: center;
            gap: 6px; font-family: 'Cinzel Decorative', serif;
        }
        .powered-text { color: #d4af37; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; padding-top: 1px; opacity: 0.8; }
        .powered-logo-img { height: 12px; width: auto; filter: grayscale(100%) invert(1) brightness(1.2) sepia(1) hue-rotate(5deg) saturate(1.5); opacity: 0.8; }

        /* --- 场景层 --- */
        .intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 2000; transition: opacity 1.5s ease-in-out;
        }
        .intro-logo-wrapper { margin-top: 30px; opacity: 0.8; animation: breathe 3s infinite ease-in-out; }
        .intro-logo-wrapper .powered-logo-img { height: 16px; }

        .stage-header-wrapper {
            position: absolute; top: 15%; width: 100%; display: flex; justify-content: center; z-index: 15;
            opacity: 0; transition: opacity 2s ease; transform: scale(0.7); 
        }
        @media (max-width: 768px) { .stage-header-wrapper { top: 12%; transform: scale(1); } }

        .top-brand {
            position: fixed; top: 25px; left: 50%; transform: translateX(-50%);
            z-index: 2100; opacity: 0; transition: opacity 2s ease; pointer-events: none;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.5; transform: scale(0.98); }
            50% { opacity: 0.9; transform: scale(1.02); }
        }

        /* --- 游戏区 --- */
        .stage-area {
            flex: 70; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; z-index: 10;
        }

        .magic-circle-container {
            position: absolute; width: 160px; height: 160px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 20; top: 50%; transform: translateY(-50%);
            opacity: 0; transition: opacity 2s ease, transform 0.8s;
        }
        @media (min-width: 768px) { .magic-circle-container { top: 55%; } }
        
        .magic-circle-container:active { transform: translateY(-50%) scale(0.95); }

        .magic-circle {
            width: 100%; height: 100%; border-radius: 50%; position: absolute;
            border: 2px dashed var(--neon); box-shadow: 0 0 30px var(--neon), inset 0 0 20px var(--neon);
            animation: rotateSlow 20s linear infinite;
            background: radial-gradient(circle, transparent 60%, rgba(157, 0, 255, 0.2));
            transition: all 0.5s;
        }
        .magic-circle.active {
            box-shadow: 0 0 80px var(--neon), inset 0 0 50px var(--neon);
            border-color: #fff; animation: rotateFast 0.5s linear infinite; 
        }
        .magic-circle::before {
            content: ''; position: absolute; width: 85%; height: 85%; border-radius: 50%;
            border: 1px solid var(--gold); border-top: 3px double var(--gold); border-bottom: 3px double var(--gold);
            top: 0; left: 0; right: 0; bottom: 0; margin: auto;
            animation: rotateSlow 12s linear infinite reverse;
        }
        .circle-hint {
            position: absolute; color: var(--gold); font-size: 14px; font-weight: bold;
            text-align: center; pointer-events: none; letter-spacing: 2px;
            text-shadow: 0 0 10px black; animation: pulseText 2s infinite;
        }

        .tornado-wrapper {
            position: absolute; width: 100%; height: 100%; top: 15%; left: 0; 
            pointer-events: none; transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center; z-index: 15;
        }
        .storm-card {
            width: var(--storm-card-w); height: var(--storm-card-h); position: absolute;
            background: #111; border: 1px solid var(--gold); border-radius: 4px;
            box-shadow: 0 0 15px rgba(157, 0, 255, 0.3);
            /* 龙卷风纹路 */
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%);
            background-size: 8px 8px;
            opacity: 0; transition: opacity 0.3s, transform 0.1s;
        }

        .deck-stack {
            width: var(--card-w); height: var(--card-h);
            position: absolute; top: 55%; left: 50%; 
            margin-left: calc(var(--card-w) / -2); margin-top: calc(var(--card-h) / -2);
            z-index: 25; pointer-events: none; opacity: 0; transition: opacity 1.5s ease-in;
        }
        .deck-card-static {
            position: absolute; width: 100%; height: 100%;
            background: #111; border: 1px solid var(--gold-dim); border-radius: 6px;
            background-image: linear-gradient(45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(197, 160, 89, 0.1) 25%, transparent 25%);
            background-size: 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .controls-wrapper {
            position: absolute; top: 76%; width: 100%; display: flex; flex-direction: column; align-items: center;
            z-index: 30; opacity: 0; transition: opacity 2s ease;
        }
        @media (min-width: 768px) { .controls-wrapper { top: 85%; } }

        .input-box {
            width: 260px; background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 8px; color: var(--gold); padding: 12px; text-align: center; outline: none; 
            font-family: 'Noto Serif SC', serif;
        }
        .status-text {
            margin-top: 20px; color: #888; font-size: 12px; letter-spacing: 1px;
            height: 20px; text-shadow: 0 2px 4px black; transition: color 0.5s;
        }

        .slots-container {
            flex: 30; width: 100%; display: flex; justify-content: space-evenly; align-items: flex-start;
            padding-top: 10px; opacity: 0; pointer-events: none; transition: opacity 1s;
            transform: translateY(-15px);
        }
        @media (min-width: 768px) {
            .slots-container { padding-bottom: 50px; align-items: flex-end; transform: translateY(0); }
        }
        .slot {
            width: var(--card-w); height: var(--card-h);
            border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; position: relative;
        }
        .slot::after {
            content: attr(data-label); position: absolute; bottom: -25px; width: 100%; 
            text-align: center; color: #444; font-size: 10px; font-family: 'Cinzel';
        }

        .flying-card {
            position: fixed; width: var(--card-w); height: var(--card-h);
            border-radius: 6px; transform-style: preserve-3d;
            transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 50; cursor: pointer;
        }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; overflow: hidden; }
        .back { background-color: #111; background-size: cover; background-position: center; border: 1px solid #444; }
        .back.default { background-image: linear-gradient(45deg, #222 25%, #111 25%), linear-gradient(-45deg, #222 25%, #111 25%); background-size: 4px 4px; }
        .back.moon { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.png'); }
        .back.star { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.png'); }
        .back.sun  { background-image: url('https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.png'); }
        
        .front { transform: rotateY(180deg); background: #000; display: flex; flex-direction: column; justify-content: flex-end; box-shadow: inset 0 0 0 1px var(--gold-dim); }
        
        .front.reversed-display { transform: rotateY(180deg) rotate(180deg); }

        .front-content { 
            padding: 8px; text-align: center; background: rgba(0,0,0,0.9); border-top: 1px solid var(--gold-dim); backdrop-filter: blur(4px); 
            transition: opacity 0.5s;
        }
        .card-name { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .card-keywords { color: #aaa; font-size: 10px; transform: scale(0.9); white-space: nowrap; }
        
        .overlay-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.5s; }

        .flying-card.zoomed .front-content { opacity: 0; }

        /* Mobile Zoom */
        @media (max-width: 767px) {
            .flying-card.zoomed {
                width: var(--card-w-zoom) !important; height: var(--card-h-zoom) !important;
                z-index: 100;
                top: 50px !important; 
                left: 50% !important;
                transform: translate(-50%, 0) scale(0.8) rotateY(180deg) !important; 
                box-shadow: 0 0 60px rgba(157, 0, 255, 0.4);
            }
            .flying-card.zoomed .front.reversed-display { transform: rotateY(180deg) rotate(180deg) !important; }
        }

        /* Desktop Zoom */
        @media (min-width: 768px) {
            .flying-card.zoomed {
                width: var(--card-w-zoom) !important; height: var(--card-h-zoom) !important;
                z-index: 100;
                top: 50% !important; left: 25% !important; 
                transform: translate(-50%, -50%) rotateY(180deg) !important;
                box-shadow: 0 0 60px rgba(157, 0, 255, 0.4);
            }
        }

        /* --- 详情文字面板 --- */
        .detail-panel {
            position: fixed; z-index: 95; opacity: 0; pointer-events: none; transition: opacity 0.5s, transform 0.5s;
            display: flex; flex-direction: column;
        }

        /* Mobile Panel: 像素级避让 */
        @media (max-width: 767px) {
            .detail-panel {
                bottom: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(to top, #050505 80%, rgba(5,5,5,0.6));
                border-top: 1px solid transparent; 
                padding: 20px; 
                padding-top: 430px; 
                overflow-y: auto; transform: translateY(0);
            }
            .detail-panel.active { opacity: 1; pointer-events: auto; }
        }

        /* Desktop Panel */
        @media (min-width: 768px) {
            .detail-panel {
                top: 50%; right: 10%; width: 40%; max-height: 80vh;
                transform: translateY(-50%) translateX(20px);
                background: rgba(0,0,0,0.6); 
                justify-content: flex-start;
                padding: 40px; 
                border-left: 2px solid var(--gold);
                backdrop-filter: blur(10px);
            }
            .detail-panel.active { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }
        }

        .panel-header { font-size: 12px; color: #666; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .panel-title { font-size: 24px; color: var(--gold); font-family: 'Cinzel Decorative'; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;}
        .panel-tag { font-size: 10px; padding: 2px 6px; border: 1px solid #444; border-radius: 4px; color: #888; }
        .panel-tag.reversed { border-color: #ff4444; color: #ff8888; }
        .panel-keywords { color: #888; font-size: 12px; margin-bottom: 15px; font-style: italic; }
        
        .panel-ai-text { font-size: 15px; line-height: 1.8; color: #e0e0e0; text-align: justify; }
        .panel-ai-text .warning { color: var(--mystic-red); font-weight: bold; }
        .panel-ai-text .hint-subtext { display: block; margin-top: 10px; font-size: 12px; color: #888; font-style: italic; opacity: 0.8; }

        /* --- 最终总结区域 --- */
        .final-display {
            position: absolute; width: 85%; max-width: 600px;
            text-align: center; opacity: 0; pointer-events: none; transition: opacity 1s ease; 
            z-index: 30; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        .final-title { 
            font-family: 'Cinzel Decorative', cursive; font-weight: 700; margin-bottom: 25px; 
            display: flex; align-items: center; justify-content: center; gap: 0; 
            font-size: 18px; letter-spacing: 12px; 
            background: linear-gradient(110deg, #d4af37 20%, #fff8dc 50%, #d4af37 80%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
        }
        .final-title::before, .final-title::after { content: ''; display: block; width: 30px; height: 1px; background: #d4af37; opacity: 0.6; }
        .final-title::before { margin-right: 16px; }
        .final-title::after { margin-left: 4px; }

        @media (min-width: 768px) {
            .final-title { font-size: 28px; letter-spacing: 20px; }
            .final-title::before, .final-title::after { width: 60px; }
            .final-title::before { margin-right: 30px; }
            .final-title::after { margin-left: 10px; }
        }

        /* V5.20 核心修改：区分手机/电脑的文字大小与行高 */
        .final-text { 
            color: #fffae0; 
            
            /* 手机默认样式 */
            font-size: 14px; /* 缩小2px (原16px) */
            line-height: 1.7; /* 稍微缩紧行高 (原1.9) */
            
            text-align: center; 
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.95) 10%, rgba(0,0,0,0.8) 50%, transparent 85%);
            padding: 30px 20px; 
            position: relative;
            width: 100%; 
            border: none;
            box-shadow: none;
            backdrop-filter: none;
        }

        /* 电脑端覆盖样式：保持原样 */
        @media (min-width: 768px) {
            .final-text {
                font-size: 16px;
                line-height: 1.9;
            }
        }

        .final-text::before {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--gold) 50%, transparent 100%);
            opacity: 0.8;
        }

        .final-text::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--gold) 50%, transparent 100%);
            opacity: 0.8;
        }

        /* 逐行淡出 */
        .mystic-line {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 3s ease, transform 3s ease; 
            margin-bottom: 8px; 
            display: block; 
        }
        .mystic-line.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes rotateSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateFast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="bg-gradient"></div>
    <div class="overlay-mask" id="mask"></div>

    <div class="detail-panel" id="detail-panel">
        <div class="panel-header" id="panel-pos">POSITION</div>
        <div class="panel-title">
            <span id="panel-name">THE FOOL</span>
            <span class="panel-tag" id="panel-status">正位</span>
        </div>
        <div class="panel-keywords" id="panel-keys">Keywords...</div>
        <div class="panel-ai-text" id="panel-text">
            </div>
    </div>

    <div class="intro-layer" id="intro-layer">
        <div class="title-block">
            <div class="cn-title"><span>命</span><span>运</span><span>回</span><span>响</span></div>
            <h1 class="main-title">DESTINY PROTOCOL</h1>
        </div>
        <div class="intro-logo-wrapper powered-container">
            <span class="powered-text">POWERED BY</span>
            <img src="https://raw.githubusercontent.com/krthaslin/taluopai/main/card/Unlogomini.png" class="powered-logo-img" alt="UncodeUncle">
        </div>
    </div>

    <div class="top-brand powered-container" id="top-brand">
        <span class="powered-text">POWERED BY</span>
        <img src="https://raw.githubusercontent.com/krthaslin/taluopai/main/card/Unlogomini.png" class="powered-logo-img" alt="UncodeUncle">
    </div>

    <div class="stage-area">
        <div class="stage-header-wrapper" id="stage-header">
            <div class="title-block">
                <div class="cn-title"><span>命</span><span>运</span><span>回</span><span>响</span></div>
                <h1 class="main-title">DESTINY PROTOCOL</h1>
            </div>
        </div>

        <div class="tornado-wrapper" id="tornado-con"></div>

        <div class="magic-circle-container" id="magic-trigger">
            <div class="magic-circle" id="magic-ring"></div>
            <div class="circle-hint" id="circle-text">长按<br>注入能量</div>
        </div>

        <div class="deck-stack" id="deck-stack">
            <div class="deck-card-static" style="transform: translateZ(0px)"></div>
            <div class="deck-card-static" style="transform: translateZ(2px) rotate(2deg)"></div>
            <div class="deck-card-static" style="transform: translateZ(4px) rotate(-1deg)"></div>
            <div class="deck-card-static" style="transform: translateZ(6px) rotate(1deg)"></div>
        </div>

        <div class="controls-wrapper" id="controls">
            <input type="text" class="input-box" id="user-input" placeholder="输入所求之事..." autocomplete="off">
            <div class="status-text" id="status-text"></div>
        </div>

        <div class="final-display" id="final-con">
            <div class="final-title">命运回响</div>
            <div class="final-text" id="ai-final-text"></div>
        </div>
    </div>

    <div class="slots-container" id="slots-area">
        <div class="slot" id="slot-0" data-label="PAST"></div>
        <div class="slot" id="slot-1" data-label="PRESENT"></div>
        <div class="slot" id="slot-2" data-label="FUTURE"></div>
    </div>

    <script>
        // 1. 视口锁定
        let lockedHeight = window.innerHeight;
        let lockedWidth = window.innerWidth;
        function lockViewport() {
            document.body.style.height = `${lockedHeight}px`;
            window.addEventListener('resize', () => {
                if (window.innerWidth !== lockedWidth) {
                    lockedWidth = window.innerWidth;
                    lockedHeight = window.innerHeight;
                    document.body.style.height = `${lockedHeight}px`;
                }
            });
        }
        
        window.addEventListener('load', () => {
            lockViewport();
            setTimeout(() => {
                const introLayer = document.getElementById('intro-layer');
                introLayer.style.opacity = '0';
                document.getElementById('stage-header').style.opacity = '1';
                document.getElementById('magic-trigger').style.opacity = '1';
                document.getElementById('controls').style.opacity = '1';
                document.getElementById('top-brand').style.opacity = '1';
                setTimeout(() => { introLayer.style.display = 'none'; }, 1500);
            }, 2000);
        });

        // 2. 塔罗数据
        const TAROT_DATA = [
            { id: "0", name: "愚者", en: "The Fool", keywords: "新的开始 · 冒险 · 纯真", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/fool.jpg" },
            { id: "I", name: "魔术师", en: "The Magician", keywords: "创造力 · 意志 · 显化", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/magician.jpg" },
            { id: "II", name: "女祭司", en: "The High Priestess", keywords: "直觉 · 神秘 · 潜意识", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/high_priestess.jpg" },
            { id: "III", name: "女皇", en: "The Empress", keywords: "丰饶 · 母性 · 自然", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/empress.jpg" },
            { id: "IV", name: "皇帝", en: "The Emperor", keywords: "权威 · 结构 · 控制", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/emperor.jpg" },
            { id: "V", name: "教皇", en: "The Hierophant", keywords: "传统 · 信仰 · 学习", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/hierophant.jpg" },
            { id: "VI", name: "恋人", en: "The Lovers", keywords: "关系 · 选择 · 和谐", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/lovers.jpg" },
            { id: "VII", name: "战车", en: "The Chariot", keywords: "行动 · 胜利 · 意志力", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/chariot.jpg" },
            { id: "VIII", name: "力量", en: "Strength", keywords: "勇气 · 耐心 · 同情", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/strength.jpg" },
            { id: "IX", name: "隐士", en: "The Hermit", keywords: "内省 · 孤独 · 指引", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/hermit.jpg" },
            { id: "X", name: "命运之轮", en: "Wheel of Fortune", keywords: "流转 · 机遇 · 宿命", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/wheel_of_fortune.jpg" },
            { id: "XI", name: "正义", en: "Justice", keywords: "公平 · 真理 · 因果", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/justice.jpg" },
            { id: "XII", name: "倒吊人", en: "The Hanged Man", keywords: "牺牲 · 等待 · 新视角", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/hanged_man.jpg" },
            { id: "XIII", name: "死神", en: "Death", keywords: "结束 · 转变 · 重生", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/death.jpg" },
            { id: "XIV", name: "节制", en: "Temperance", keywords: "平衡 · 治愈 · 融合", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/temperance.jpg" },
            { id: "XV", name: "恶魔", en: "The Devil", keywords: "束缚 · 欲望 · 物质", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/devil.jpg" },
            { id: "XVI", name: "高塔", en: "The Tower", keywords: "崩塌 · 启示 · 突变", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/tower.jpg" },
            { id: "XVII", name: "星星", en: "The Star", keywords: "希望 · 灵感 · 宁静", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/star.jpg" },
            { id: "XVIII", name: "月亮", en: "The Moon", keywords: "幻觉 · 不安 · 潜意识", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/moon.jpg" },
            { id: "XIX", name: "太阳", en: "The Sun", keywords: "成功 · 喜悦 · 活力", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/sun.jpg" },
            { id: "XX", name: "审判", en: "Judgement", keywords: "觉醒 · 召唤 · 新生", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/judgement.jpg" },
            { id: "XXI", name: "世界", en: "The World", keywords: "圆满 · 完成 · 旅程", img: "https://raw.githubusercontent.com/krthaslin/taluopai/main/card/world.jpg" }
        ];

        // 3. 游戏状态
        let state = {
            shuffling: false, 
            destinyLocked: false, 
            selectedCards: [], 
            currentSlot: 0,
            cardsRevealed: 0, 
            tornadoCards: [], 
            animationFrame: null, 
            synthesisShown: false, 
            currentAiResponse: null, 
            isSessionValid: true 
        };

        const invalidPhrases = [
            "心念未聚，牌面无相。唯有诚挚发问，方能拨开迷雾。",
            "虚空不语，因你的叩问缺乏回响的根基。",
            "杂念如尘，蒙蔽星光。请收束思绪，方可见真章。",
            "命运之轮静止不动，因推动它的意念太过微弱。",
            "镜中无相，因心无定所。虚妄的试探得不到真实的倒影。",
            "你的低语消散在以太风暴中，未能触达神谕的核心。",
            "无源之水，难成图景。空洞的符号无法承载命运的重量。",
            "群星静默，它们不解无诚之问。",
            "灵性链接无法锚定游离的意识，请注入真实的愿力。",
            "命运不可戏弄，虚妄的试探只会得到虚妄的回响。"
        ];

        const errorPhrases = [
            "以太乱流阻断了回响。或许此刻并非窥探命运的最佳时机，请稍作歇息。",
            "灵性链接因剧烈波动而断开。请平复心境，切勿焦躁强求。",
            "虚空深处传来杂音，掩盖了神谕。这通常意味着提问者心绪未宁。",
            "星盘运转出现了罕见的停滞。命运拒绝在混乱中显化，请耐心等待能量归位。",
            "来自彼岸的信号过于微弱。也许宇宙在暗示你：当下的困惑，需由你自己寻找答案。",
            "维度之门暂时紧闭。过度的试探会扰乱因果，请怀着敬畏之心稍后再试。",
            "能量场过载，连接被迫中断。凡事不可强求，顺势而为方是智慧。",
            "潜意识的迷雾太重，无法映照出清晰的倒影。待迷雾散去，真理自现。",
            "共振频率失调。请试着深呼吸，找回内心的平静，命运自会重新连接。",
            "不可言说的力量干扰了这次通讯。这不是拒绝，而是宇宙让你‘停下来’的提示。"
        ];

        const hintSubtext = "（请摒弃杂念，凝神静气，向虚空投射你最真实的疑惑。）";

        function getRandomPhrase(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        const trigger = document.getElementById('magic-trigger');
        const ring = document.getElementById('magic-ring');
        const circleText = document.getElementById('circle-text');
        const tornadoCon = document.getElementById('tornado-con');
        const inputBox = document.getElementById('user-input');
        const statusText = document.getElementById('status-text');
        const deckStack = document.getElementById('deck-stack');
        const controls = document.getElementById('controls');
        const finalCon = document.getElementById('final-con');
        const detailPanel = document.getElementById('detail-panel');

        trigger.addEventListener('mousedown', startChanneling);
        trigger.addEventListener('touchstart', (e) => { e.preventDefault(); startChanneling(); });
        trigger.addEventListener('mouseup', stopChanneling);
        trigger.addEventListener('touchend', stopChanneling);

        function startChanneling() {
            if (state.destinyLocked) return;
            
            const query = inputBox.value;
            if (!query) {
                statusText.innerText = "请先输入心中的疑惑...";
                statusText.style.color = "#ff4444";
                return;
            }

            state.shuffling = true;
            ring.classList.add('active');
            circleText.innerText = "能量注入中..."; 
            statusText.innerText = "";
            createTornado();
            generateDestiny();
            fetchAiInterpretation(query, state.selectedCards);
        }

        function generateDestiny() {
            const shuffled = [...TAROT_DATA].sort(() => 0.5 - Math.random());
            state.selectedCards = [
                { ...shuffled[0], position: "过去", enPos: "PAST", isReversed: Math.random() > 0.5 },
                { ...shuffled[1], position: "现在", enPos: "PRESENT", isReversed: Math.random() > 0.5 },
                { ...shuffled[2], position: "未来", enPos: "FUTURE", isReversed: Math.random() > 0.5 }
            ];
            console.log("命运已在本地生成:", state.selectedCards);
        }

        function stopChanneling() {
            if (!state.shuffling) return;
            state.shuffling = false;
            ring.classList.remove('active');
            cancelAnimationFrame(state.animationFrame);
            lockVisuals(); 
            destroyTornado();
        }

        async function fetchAiInterpretation(query, cards) {
            console.log("发起真实请求...", query, cards);
            
            try {
                const response = await fetch('/api/tarot', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, cards: cards })
                });

                if (response.status === 200) {
                    const data = await response.json();
                    if (data.result) {
                        state.currentAiResponse = data.result;
                        console.log("AI 数据接收成功:", state.currentAiResponse);
                    }
                } else {
                    console.error("API Error Status:", response.status);
                    const errorMsg = getRandomPhrase(errorPhrases);
                    state.currentAiResponse = { 
                        valid: true, 
                        card_1_interpretation: "迷雾笼罩...", 
                        card_2_interpretation: "无法看清...", 
                        card_3_interpretation: "无法看清...", 
                        final_synthesis: errorMsg 
                    };
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                const errorMsg = getRandomPhrase(errorPhrases);
                state.currentAiResponse = { 
                    valid: true, 
                    card_1_interpretation: "虚空震荡...", 
                    card_2_interpretation: "无法建立连接...", 
                    card_3_interpretation: "无法建立连接...", 
                    final_synthesis: errorMsg 
                };
            }
        }

        // V5.17: 龙卷风逻辑
        function createTornado() {
            tornadoCon.innerHTML = ''; state.tornadoCards = [];
            const isDesktop = window.innerWidth > 768;
            const count = isDesktop ? 60 : 36; 
            const yRange = isDesktop ? 1000 : 600; 
            const rBase = isDesktop ? 350 : 120;    
            const rVar = isDesktop ? 400 : 150;      

            for (let i = 0; i < count; i++) {
                const card = document.createElement('div');
                card.className = 'storm-card';
                tornadoCon.appendChild(card);
                const t = {
                    el: card, angle: (i / count) * 360,
                    y: (Math.random() - 0.5) * yRange, radius: rBase + Math.random() * rVar,
                    // V5.17: 电脑端速度减慢
                    baseSpeed: isDesktop ? (0.5 + Math.random() * 1) : (2 + Math.random() * 3), 
                    speed: 0
                };
                state.tornadoCards.push(t);
                setTimeout(() => { card.style.opacity = 0.8; }, Math.random() * 200);
            }
            animateTornado();
        }

        function animateTornado() {
            if (!state.shuffling) return;
            const time = Date.now() / 1000;
            const wave = Math.sin(time * 2); 
            const speedMultiplier = 1 + (wave * 0.5); 
            state.tornadoCards.forEach(t => {
                const currentSpeed = t.baseSpeed * speedMultiplier;
                t.angle += currentSpeed;
                t.el.style.transform = `translateY(${t.y}px) rotateY(${t.angle}deg) translateZ(${t.radius}px)`;
            });
            state.animationFrame = requestAnimationFrame(animateTornado);
        }

        function destroyTornado() {
            state.tornadoCards.forEach((t, i) => {
                t.el.style.transition = 'all 0.6s ease-in';
                t.el.style.transform = `translateY(0px) rotateY(${t.angle + 180}deg) translateZ(0px) scale(0.1)`;
                t.el.style.opacity = 0;
            });
            setTimeout(() => { tornadoCon.innerHTML = ''; showDeckStack(); }, 800);
        }

        function showDeckStack() {
            trigger.style.opacity = 0; trigger.style.pointerEvents = 'none';
            controls.style.opacity = 0;
            document.getElementById('stage-header').style.opacity = 0;

            deckStack.style.opacity = 1;
            setTimeout(() => {
                deckStack.style.pointerEvents = 'auto'; deckStack.onclick = distributeCard;      
                statusText.style.color = "#888";
                statusText.innerText = "命运已定。请依次点击牌堆，抽取过去、现在、未来。";
                statusText.style.opacity = 1;
                controls.style.opacity = 1; inputBox.style.display = 'none';
            }, 800);
        }

        function lockVisuals() {
            state.destinyLocked = true;
            document.getElementById('slots-area').style.opacity = 1;
        }

        function distributeCard() {
            if (state.currentSlot > 2) return;
            const index = state.currentSlot;
            const targetSlot = document.getElementById(`slot-${index}`);
            const cardData = state.selectedCards[index];
            const card = document.createElement('div');
            card.className = 'flying-card';
            
            let skin = 'default';
            if (index === 0) skin = 'moon'; if (index === 1) skin = 'star'; if (index === 2) skin = 'sun';

            const reverseClass = cardData.isReversed ? 'reversed-display' : '';

            card.innerHTML = `
                <div class="face back ${skin}"></div>
                <div class="face front ${reverseClass}" style="background-image: url('${cardData.img}'); background-size: cover; background-position: center;">
                    <div class="front-content">
                        <div class="card-name">${cardData.name}</div>
                        <div class="card-keywords">${cardData.keywords}</div>
                    </div>
                </div>`;
                
            const startRect = deckStack.getBoundingClientRect();
            card.style.left = startRect.left + 'px'; card.style.top = startRect.top + 'px';
            document.body.appendChild(card);
            
            const endRect = targetSlot.getBoundingClientRect();
            requestAnimationFrame(() => { card.style.transform = `translate(${endRect.left - startRect.left}px, ${endRect.top - startRect.top}px)`; });
            
            card.onclick = () => revealCard(card, index);
            state.currentSlot++;
            
            if (state.currentSlot > 2) {
                deckStack.style.opacity = 0; deckStack.style.pointerEvents = 'none';
                statusText.innerText = "请点击卡片，查看详情。";
            }
        }

        function revealCard(cardEl, index) {
            // 1. Zoom
            cardEl.classList.add('zoomed'); 
            const mask = document.getElementById('mask');
            mask.style.opacity = 1;
            mask.style.pointerEvents = 'auto'; // V5.16: 实体化遮罩
            
            // 2. Data Fill
            const data = state.selectedCards[index];
            const panelName = document.getElementById('panel-name');
            const panelStatus = document.getElementById('panel-status');
            const panelKeys = document.getElementById('panel-keys');
            const panelText = document.getElementById('panel-text');
            const panelPos = document.getElementById('panel-pos');

            panelPos.innerText = data.enPos;
            panelName.innerText = data.en;
            panelKeys.innerText = data.keywords;
            
            if (data.isReversed) {
                panelStatus.innerText = "逆位 (Reversed)";
                panelStatus.classList.add('reversed');
            } else {
                panelStatus.innerText = "正位 (Upright)";
                panelStatus.classList.remove('reversed');
            }

            fillAiText(index, panelText);

            // 3. Show Panel
            detailPanel.classList.add('active');

            // 4. Bind Close Events (V5.16: 全域点击关闭)
            const closeAction = (e) => { 
                if(e) e.stopPropagation(); 
                returnCard(cardEl, index); 
            };

            cardEl.onclick = closeAction;
            mask.onclick = closeAction;
            detailPanel.onclick = closeAction;
        }

        function fillAiText(index, element) {
            element.innerHTML = ""; 
            
            if (!state.currentAiResponse) {
                element.innerHTML = "<span style='color:#888'>正在聆听虚空的低语...</span>";
                const waitInterval = setInterval(() => {
                    if (state.currentAiResponse) {
                        clearInterval(waitInterval);
                        displayActualText(index, element);
                    }
                }, 500);
            } else {
                displayActualText(index, element);
            }
        }

        function displayActualText(index, element) {
            element.innerHTML = ""; 
            const resp = state.currentAiResponse;
            if (!resp.valid) {
                const randomMsg = getRandomPhrase(invalidPhrases);
                element.innerHTML = `<span class='warning'>${randomMsg}</span><span class='hint-subtext'>${hintSubtext}</span>`;
                return;
            }
            let text = "";
            if (index === 0) text = resp.card_1_interpretation;
            if (index === 1) text = resp.card_2_interpretation;
            if (index === 2) text = resp.card_3_interpretation;
            
            let i = 0;
            function type() { 
                if (i < text.length) { 
                    element.innerHTML += text.charAt(i); i++; 
                    setTimeout(type, 20); 
                } 
            }
            type();
        }

        function returnCard(cardEl, index) {
            cardEl.classList.remove('zoomed'); 
            cardEl.classList.add('revealed');
            detailPanel.classList.remove('active'); 
            
            const mask = document.getElementById('mask');
            mask.style.opacity = 0;
            mask.style.pointerEvents = 'none'; 
            
            mask.onclick = null;
            detailPanel.onclick = null;
            
            setTimeout(() => { 
                cardEl.onclick = () => revealCard(cardEl, index); 
            }, 300);
            
            if (!cardEl.hasAttribute('data-read')) {
                cardEl.setAttribute('data-read', 'true');
                state.cardsRevealed++;
                if (state.cardsRevealed === 3 && !state.synthesisShown) { 
                    state.synthesisShown = true; 
                    setTimeout(showSynthesis, 1000); 
                }
            }
        }

        function showSynthesis() {
            statusText.style.opacity = 0; 
            finalCon.style.opacity = 1; 
            finalCon.style.pointerEvents = 'auto';
            const aiTextElement = document.getElementById('ai-final-text');
            aiTextElement.innerHTML = ""; 

            const startFade = (textStr) => {
                fadeInTextLineByLine(textStr, aiTextElement);
            };

            if (state.currentAiResponse && state.currentAiResponse.valid) {
                startFade(state.currentAiResponse.final_synthesis);
            } else if (state.currentAiResponse && !state.currentAiResponse.valid) {
                const randomMsg = getRandomPhrase(invalidPhrases);
                aiTextElement.innerHTML = `<span class='warning'>${randomMsg}</span>`;
            } else {
                 const checkInterval = setInterval(() => {
                    if (state.currentAiResponse) { 
                        clearInterval(checkInterval); 
                        if(state.currentAiResponse.valid) {
                             startFade(state.currentAiResponse.final_synthesis); 
                        } else {
                             const randomMsg = getRandomPhrase(invalidPhrases);
                             aiTextElement.innerHTML = `<span class='warning'>${randomMsg}</span>`;
                        }
                    }
                }, 500);
            }
        }

        function fadeInTextLineByLine(text, container) {
            const lines = text.split(/[。！？\n]+/).filter(line => line.trim().length > 0);
            
            lines.forEach((line, index) => {
                const p = document.createElement('span'); 
                p.className = 'mystic-line';
                p.innerText = line + "。"; 
                container.appendChild(p);

                setTimeout(() => {
                    p.classList.add('show');
                }, 1000 + index * 2500);
            });
        }
    </script>
</body>
</html>


